# 概述

- 提供程序运行时的环境变量管理功能。这里的环境变量不仅包括系统环境变量，还包括程序自定义环境变量，命令行参数，帮助选项与描述，以及程序运行路径相关的信息。
- 所谓环境变量就是程序运行时可直接获取和设置的一组变量，它们往往代表一些特定的含义。所有的环境变量都以 key-value 的形式存储，key 和 value 都是字符串形式。这里可以参考系统环境变量来理解，在程序运行时，可以通过调用 getenv()/setenv() 接口来获取/设置系统环境变量，比如 getenv("PWD") 来获取当前路径。
- 在 shell 中可以通过 printenv 命令来打印当前所有的环境变量，并且在当前 shell 中运行的所有程序都共享这组环境变量值。
- 其他类型的环境变量也可以类比系统环境变量，只不过系统环境变量由 shell 来保存，而其他类型的环境变量由程序自己内部存储，但两者效果是一样的。具体地，sylar定义了以下几类环境变量：
	1. 系统环境变量，由 shell 保存，sylar 环境变量模块提供 getEnv()/setEnv() 方法用于操作系统环境变量。
	2. 程序自定义环境变量，对应 get()/add()/has()/del() 接口，自定义环境变量保存在程序自己的内存空间中，在内部实现为一个 std::map<std::string, std::string> 结构。
	3. 命令行参数，通过解析 main 函数的参数得到。所有参数都被解析成“选项-选项值”的形式，选项只能以-开头，后面跟选项值。如果一个参数只有选项没有值，那么值为空字符串。命令行参数也保存在程序自定义环境变量中。
	4. 帮助选项与描述。这里是为了统一生成程序的命令行帮助信息，在执行程序时如果指定了 -h 选项，那么就打印这些帮助信息。帮助选项与描述也是存储在程序自己的内存空间中，在内部实现为一个 std::vector<std::pair<std::string, std::string> > 结构。
	5. 与程序运行路径相关的信息，包括记录程序名，程序路径，当前路径，这些由单独的成员变量来存储。


# Env

- 封装环境变量类。
- 单例模式。通过单例可以保证程序的环境变量是全局唯一的，便于统一管理。
- Env 类提供以下方法：
	1. init: 环境变量模块初始化，需要将 main 函数的参数原样传入 init 接口中，以便于从 main 函数参数中提取命令行选项与值，以及通过 argv[0] 参数获取命令行程序名称。
	2. add/get/has/del：用于操作程序自定义环境变量，参数为 key-value，get 操作支持传入默认值，在对应的环境变量不存在时，返回这个默认值。
	3. setEnv/getEnv: 用于操作系统环境变量，对应标准库的 setenv/getenv 操作。
	4. addHelp/removeHelp/printHelp: 用于操作帮助选项和描述信息。
	5. getExe/getCwd/getAbsolutePath: 用于获取程序名称、程序路径、绝对路径。
	6. getConfigPath: 获取配置文件夹路径，配置文件夹路径由命令行 -c 选项传入。


# Application

- Server 主体框架：
	1. 防止重复启动多次（通过把 pid 写入文件里面去实现）
	2. 初始化日志文件路径（/path/to/log）
	3. 工作目录的路径（/path/to/work）
	4. 解析 httpserver 配置，通过配置，启动 httpserver。


# 其他说明

- 环境变量环境的一些实现细节：
	1. 获取程序的 bin 文件绝对路径是通过 /proc/$pid/ 目录下 exe 软链接文件指向的路径来确定的，用到了 readlink(2) 系统调用。
	2. 通过 bin 文件绝对路径可以得到 bin 文件所在的目录，只需要将最后的文件名部分去掉即可。
	3. 通过 argv[0] 获得命令行输入的程序路径，注意这里的路径可能是以 ./ 开头的相对路径。
	4. 通过 setenv/getenv 操作系统环境变量，参考 setenv(3), getenv(3)。
	5. 提供 getAbsolutePath 方法，传入一个相对于 bin 文件的路径，返回这个路径的绝对路径。比如默认的配置文件路径就是通过 getAbsolutePath(get("c", "conf")) 来获取的，也就是配置文件夹默认在 bin 文件所在目录的 conf 文件夹。
	6. 按使用惯例，main 函数执行的第一条语句应该就是调用 Env 的 init 方法初始化命令行参数。
- /proc/$pid/目录下的一些信息
	```shell
	/proc/$pid/cmd	启动的路径
	/proc/$pid/cmdline	exe(这个所带的路径不一定是绝对路径，它是执行程序的命令的路径)、启动参数（即传给 main 函数的参数）
	/proc/$pid/exe	exe(带上绝对路径)
	```
- 可以利用 /proc/$pid/cmdline 和全局变量构造函数，实现在进入 main 函数前解析启动参数。


# 待完善

- sylar 在解析命令行参数时，没有使用 getopt()/getopt_long() 接口，而是使用了自己编写的解析代码，这就导致 sylar 的命令行参数不支持长选项和选项合并，像 ps -aux 这样的多个选项组合在一起的命令行参数以及 ps --help 这样的长选项是不支持的。
- Application 有较多未完成的功能点，例如，ZKServiceDiscovery 和 RockSDLoadBalance。
